# Physical and Virtual Addressing
# 物理和虚拟寻址

计算机系统的主存被组织成一个由 M 个连续的字节大小的单元组成的数组。每字节都有一个唯一的物理地址（Physical Address，PA）。第一个字节的地址为 0，接下来的字节地址为 1，再下一个为 2，依此类推。给定这种简单的结构，CPU 访问内存的最自然的方式就是使用物理地址。我们把这种方式称为物理寻址（`physical addressing`）。

图 9-1 展示了一个物理寻址的示例，该示例的上下文是一条加载指令，它读取从物理地址 4 处开始的 4 字节字。当 CPU 执行这条加载指令时，会生成一个有效物理地址，通过内存总线，把它传递给主存。主存取岀从物理地址 4 处开始的 4 字节字，并将它返回给 CPU，CPU 会将它存放在一个寄存器里。

早期的 PC 使用物理寻址，而且诸如数字信号处理器、嵌入式微控制器以及 Cray 超级计算机这样的系统仍然继续使用这种寻址方式。

====================================================================================================
物理寻址（Physical Addressing）是计算机内存管理中的一个概念，它涉及到如何在计算机的物理内存（RAM）中定位和访问数据。

1. **基本概念**：物理寻址是指直接使用物理内存地址来访问内存。物理地址是内存芯片上实际电路的地址。当 CPU 或其他硬件组件需要读取或写入内存时，它们使用这些物理地址来确定应该访问内存的哪个位置。

2. **与虚拟寻址的对比**：在现代操作系统中，通常使用虚拟内存来管理内存。这意味着操作系统和应用程序使用虚拟地址来访问内存，而这些虚拟地址通过内存管理单元（MMU）转换为物理地址。虚拟寻址允许更高效和安全的内存管理，例如通过实现进程隔离和内存分页。

3. **物理寻址的局限性**：物理寻址的一个主要局限是它对内存的直接和完全访问。这意味着每个程序都可以访问内存的任何位置，这可能导致安全问题和程序间的冲突。此外，物理寻址不支持如内存交换和动态内存分配等现代内存管理技术。

4. **在早期计算机中的使用**：在早期的计算机系统和一些嵌入式系统中，物理寻址更为常见，因为它们的内存管理需求相对简单。

5. **硬件层面的实现**：在硬件层面，物理地址通常由内存控制器和 CPU 直接处理，这是与硬件紧密相关的低级操作。

总之，物理寻址是一种直接访问计算机物理内存的方法，与虚拟寻址相比，它更简单直接，但在现代计算机系统中，由于其局限性，通常不作为主要的内存访问方式。
====================================================================================================


然而，现代处理器使用的是一种称为虚拟寻址（`virtual addressing`）的寻址形式，参见图 9-2。

使用虚拟寻址，CPU 通过生成一个虚拟地址（Virtual Address，VA）来访问主存，这个虚拟地址在被送到内存之前先转换成适当的物理地址。
将一个虚拟地址转换为物理地址的任务叫做地址翻译（`address translation`）。
就像异常处理一样，地址翻译需要 CPU 硬件和操作系统之间的紧密合作。
CPU 芯片上叫做内存管理单元（`Memory Management Unit`，MMU）的专用硬件，利用存放在主存中的查询表来动态翻译虚拟地址，该表的内容由操作系统管理。

(VA) -> [MMU] -> (PA)

====================================================================================================
Memory Management Unit（MMU）是计算机硬件的一个关键部分，负责处理与内存相关的操作，尤其是内存地址的转换和内存访问的控制。
MMU的主要功能和特点包括：

1. **地址转换**：
   - **虚拟内存到物理内存的映射**：MMU 将操作系统和应用程序使用的虚拟地址转换为物理内存地址。这是通过查找页表来完成的，页表存储了虚拟地址到物理地址的映射关系。
   - **页表**：页表是一种数据结构，通常存储在内存中，由操作系统维护。MMU 使用这些页表来将虚拟地址映射到物理地址。

2. **内存保护**：
   - **隔离和保护**：MMU 通过确保每个进程只能访问其虚拟内存空间中的地址来提供内存隔离。这防止了一个进程访问或修改另一个进程的数据。
   - **权限检查**：MMU 还执行权限检查，确保进程只能以适当的方式（如只读、读写）访问其允许访问的内存区域。

3. **分页和分段**：
   - **分页**：分页是一种内存管理技术，它将内存划分为固定大小的单元，称为“页”。MMU 通过页表来管理这些页。
   - **分段**：在某些系统中，MMU 也可以支持分段内存管理，其中内存被划分为不同大小的“段”。

4. **交换和分页错误处理**：
   - 当物理内存不足时，MMU 可以协助操作系统将不活跃的内存页移动到硬盘上（交换或者分页），从而为其他进程腾出空间。
   - 当程序访问的内存页不在物理内存中时（例如，被交换到磁盘上），MMU 会生成一个分页错误（page fault），通知操作系统需要将该页调入内存。

5. **缓存管理**：
   - MMU 可能与 CPU 的缓存（如 TLB - Translation Lookaside Buffer）紧密集成，以加速地址转换过程。

6. **硬件支持**：
   - MMU 通常是 CPU 的一部分，但在一些架构中，它可能是一个独立的芯片或集成在其他芯片上。

7. **对操作系统的影响**：
   - MMU 的设计和功能对操作系统的内存管理策略有重大影响。操作系统必须按照 MMU 的要求维护页表，并处理由 MMU 生成的各种内存相关事件（如分页错误）。

综上所述，MMU 是现代计算机体系结构中至关重要的组成部分，它不仅使得虚拟内存成为可能，还提供了内存保护、错误处理和优化内存访问性能的功能。MMU 的存在和操作对于保证计算机系统稳定性和安全性至关重要。
====================================================================================================
